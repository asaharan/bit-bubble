/*!
 * Bit Bubble
 * http://github.com/asaharan/bit-bubble
 * @licence MIT
*/
'use strict';

function initWidth(){window.innerWidth-16<width&&(width=window.innerWidth-16,width<390&&(width=390))}function resizeGrid(v){size=parseInt(v),window.localStorage.GridSize=v}function Bit(side){this.side=side,this.value=0,this.classList=["bit",this.side,"invisible"],this.x=0,this.y=0,this.htmlNode=null}function BitManager(){this.bits={},this.events=[],this.mainGrid=document.querySelector(".mainGrid"),this.setup(),this.time=400}function handleNewGame(){ga("send","event",{eventCategory:"Game",eventAction:"New game",eventLabel:size})}function handleRestartGame(){ga("send","event",{eventCategory:"Game",eventAction:"Restart",eventLabel:size}),handleNewGame()}function GameManager(gridManager,styleSheetManager,bitManager,masterLogic){this.gridManager=new gridManager,this.styleSheetManager=new styleSheetManager,this.bitManager=new bitManager,this.masterLogic=new masterLogic,this.init(),this.xbitManager=bitManager,this.xgridManager=gridManager,window.scoreManager=new Score,handleNewGame()}function Score(){this.defaultScore=512,this.localStorageBestScoreName="bit-bubble-high-score-object",this.size=size,this.currentScoreHTMLNode=document.querySelector(".currentScore"),this.bestScoreHTMLNode=document.querySelector(".bestScore"),this.currentScore=this.defaultScore,this.max=window.localStorage.getItem("bit-bubble-high-score")||512,this.max=this.getBestScore(),this.applyChanges()}function Grid(){var self=this;this.events=[],this.grid=[],this.previousGrid=[],this.fixedTile=null,this.size=size,this.initialValue=initialValue,this.gridContainerOuter=document.querySelector(".gridContainerOuter"),this.gridContainerInner=document.querySelector(".gridContainerInner"),this.backgroundGrid=document.querySelector(".backgroundGrid"),this.mainGrid=document.querySelector(".mainGrid"),window.requestAnimationFrame(function(){self.setup()})}function MasterLogic(){this.size=size}function Stylesheet(){this.setup()}function Tile(x,y,value){this.x=x,this.y=y,this.value=value,this.nextValue=null,this.isVisible=!0,this.isFixed=!1,this.htmlNode=null,this.time=200,this.classList=["tile",this.positionClass(),"visible","new"]}!function(){for(var lastTime=0,vendors=["ms","moz","webkit","o"],x=0;x<vendors.length&&!window.requestAnimationFrame;++x)window.requestAnimationFrame=window[vendors[x]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[vendors[x]+"CancelAnimationFrame"]||window[vendors[x]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(callback,element){var currTime=(new Date).getTime(),timeToCall=Math.max(0,16-(currTime-lastTime)),id=window.setTimeout(function(){callback(currTime+timeToCall)},timeToCall);return lastTime=currTime+timeToCall,id}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(id){clearTimeout(id)})}();var size=6,directions={up:1,right:2,down:3,left:4},game,initialValue=512,width=502,minSpace=10;initWidth(),window.addEventListener("resize",initWidth),window.requestAnimationFrame(function(){var s=window.localStorage.GridSize;void 0!=s||null!=s?size=parseInt(s):console.log(s),document.querySelector(".levelselect").value=size,new GameManager(Grid,Stylesheet,BitManager,MasterLogic)}),Bit.prototype.getPositionClass=function(){return"bit-"+this.x+"-"+this.y},Bit.prototype.createHTMLBit=function(){var bit=document.createElement("div");return bit.setAttribute("class","bit "+this.side),this.htmlNode=bit,bit},Bit.prototype.applyClasses=function(){this.htmlNode.setAttribute("class",this.classList.join(" "))},BitManager.prototype.setup=function(){this.bits[directions.up]=new Bit("up"),this.bits[directions.right]=new Bit("right"),this.bits[directions.down]=new Bit("down"),this.bits[directions.left]=new Bit("left");for(var bit in this.bits)this.mainGrid.appendChild(this.bits[bit].createHTMLBit())},BitManager.prototype.moveBit=function(bitIndex,initialPosition,finalPosition,bitValue,destroy){var self=this,bit=this.bits[bitIndex];bit.value=bitValue,bit.x=initialPosition.x,bit.y=initialPosition.y,bit.htmlNode.textContent=bitValue,bit.classList[4]="",bit.classList[3]=bit.getPositionClass(),bit.applyClasses(),window.requestAnimationFrame(function(){window.requestAnimationFrame(function(){bit.x=finalPosition.x,bit.y=finalPosition.y,bit.classList[3]=bit.getPositionClass(),bit.classList[2]="visible",bit.classList[4]="transition",1==destroy&&(console.log(bitIndex,initialPosition,finalPosition,bitValue),bit.classList[5]="destroy-"+bitIndex),bit.applyClasses(),setTimeout(function(){bit.classList.length=2,bit.htmlNode.textContent="",bit.applyClasses(),1==destroy||self.emit("mergeComplete",{position:finalPosition,valueTobeAdded:bitValue})},self.time)})})},BitManager.prototype.on=function(event,callback){this.events[event]||(this.events[event]=[]),this.events[event].push(callback)},BitManager.prototype.emit=function(event,data){var callbacks=this.events[event];callbacks&&callbacks.forEach(function(callback){callback(data)})},GameManager.prototype.init=function(){console.log(document.querySelector(".tryAgain")),document.querySelector(".newGame").addEventListener("click",this.restart.bind(this)),document.querySelector(".tryAgain").addEventListener("click",this.restart.bind(this)),this.gridManager.on("tileClick",this.play.bind(this)),this.bitManager.on("mergeComplete",this.onMerge.bind(this))},GameManager.prototype.restart=function(){scoreManager=new Score,document.getElementById("gameOverContainer").setAttribute("class","gameOver");var self=this;self.gridManager=null,self.bitManager=null,this.styleSheetManager.setup(),document.querySelector(".mainGrid").innerHTML="",window.requestAnimationFrame(function(){self.gridManager=new self.xgridManager,self.bitManager=new self.xbitManager,self.gridManager.on("tileClick",self.play.bind(self)),self.bitManager.on("mergeComplete",self.onMerge.bind(self))}),handleRestartGame()},GameManager.prototype.play=function(clickedTile){var self=this;clickedTile.isVisible=!1;var availableDirections=this.masterLogic.directions(clickedTile.position());if(availableDirections){var scoreOfBit=parseInt(clickedTile.value/availableDirections.length);availableDirections.forEach(function(direction){var nextTile=self.gridManager.findNextTile(clickedTile.position(),direction);null!=nextTile?self.bitManager.moveBit(direction,clickedTile.position(),nextTile.position(),scoreOfBit):(console.log("next tile not found for ",direction,directions),self.bitManager.moveBit(direction,clickedTile.position(),clickedTile.position(),scoreOfBit,!0))})}this.gridManager.applyChanges()},GameManager.prototype.onMerge=function(mergeDetails){var tileToBeUpdated=this.gridManager.findTileByPosition(mergeDetails.position);tileToBeUpdated.nextValue=tileToBeUpdated.value+mergeDetails.valueTobeAdded,this.gridManager.applyChanges(),scoreManager.updateScore(this.gridManager.currentScore()),this.gridManager.isGameOver()&&setTimeout(function(){document.getElementById("gameOverContainer").setAttribute("class","gameOver open")},300)},Score.prototype.getBestScore=function(size){size=size||this.size;var v=JSON.parse(window.localStorage.getItem(this.localStorageBestScoreName));return null==v?this.defaultScore:v[size]||this.defaultScore},Score.prototype.setBestScore=function(max,size){max=max||this.max,size=size||this.size;var v=JSON.parse(window.localStorage.getItem(this.localStorageBestScoreName));null==v&&(v={}),v[size]=max,window.localStorage.setItem(this.localStorageBestScoreName,JSON.stringify(v))},Score.prototype.updateScore=function(currentScore){"number"==typeof currentScore&&(this.currentScore=currentScore,this.max<this.currentScore&&(this.max=this.currentScore,this.setBestScore()),this.applyChanges())},Score.prototype.applyChanges=function(){this.bestScoreHTMLNode.innerHTML=this.max,this.currentScoreHTMLNode.innerHTML=this.currentScore},Grid.prototype.emptyGrid=function(){this.applyChanges()},Grid.prototype.setup=function(){var i,j,randomPosition=this.getRandomPosition();for(i=0;i<this.size;i++)for(j=0;j<this.size;j++){var tile;tile=i==randomPosition.x&&j==randomPosition.y?this.createTile({x:i,y:j},this.initialValue,!0):this.createTile({x:i,y:j},this.initialValue,!1),tile.addEventListener("click",this.onTileClick.bind(this)),this.mainGrid.appendChild(tile)}},Grid.prototype.createTile=function(position,value,isFixed){var tile=new Tile(position.x,position.y,value);return 1==isFixed&&(tile.classList[4]="fixed",tile.isFixed=!0,this.fixedTile=tile),tile.isVisible=!0,this.grid.push(tile),tile.makeHTMLNode()},Grid.prototype.getRandomPosition=function(){var random={};return random.x=Math.floor(Math.random()*this.size),random.y=Math.floor(Math.random()*this.size),random},Grid.prototype.applyChanges=function(){console.log("grid",this.grid),this.grid.forEach(function(tile){tile.applyChanges()})},Grid.prototype.applyClasses=function(element,classes){element.setAttribute("class",classes.join(" "))},Grid.prototype.on=function(event,callback){this.events[event]||(this.events[event]=[]),this.events[event].push(callback)},Grid.prototype.emit=function(event,data){var callbacks=this.events[event];callbacks&&callbacks.forEach(function(callback){callback(data)})},Grid.prototype.onTileClick=function(event){return event.target==this.fixedTile.htmlNode||0==this.findTileById(event.target.id).isVisible?void console.log(event.target):void this.emit("tileClick",this.findTileById(event.target.id))},Grid.prototype.findTileById=function(id){var tile=null;return this.grid.forEach(function(t){t.positionClass()==id&&(tile=t)}),tile},Grid.prototype.findNextTile=function(position,dir){var toMerge=null,i=0;if(directions.right==dir){for(i=position.x+1;i<this.size;i++)if(toMerge=this.findTileByPosition({x:i,y:position.y}),null!=toMerge)return toMerge;return null}if(directions.down==dir){for(i=position.y+1;i<this.size;i++)if(toMerge=this.findTileByPosition({x:position.x,y:i}),null!=toMerge)return toMerge;return null}if(directions.left==dir){for(i=position.x-1;i>-1;i--)if(toMerge=this.findTileByPosition({x:i,y:position.y}),null!=toMerge)return toMerge;return null}if(directions.up==dir){for(i=position.y-1;i>=-1;i--)if(toMerge=this.findTileByPosition({x:position.x,y:i}),null!=toMerge)return toMerge;return null}return!1},Grid.prototype.findTileByPosition=function(position){var tileToReturn=null;return this.grid.forEach(function(tile){var tilePosition=tile.position();tilePosition.x==position.x&&tilePosition.y==position.y&&1==tile.isVisible&&(tileToReturn=tile)}),tileToReturn},Grid.prototype.isGameOver=function(){var isOver=!0;for(a in directions)if(null!=this.findNextTile(this.fixedTile.position(),directions[a])){isOver=!1,console.warn("isOver",directions[a],this.findNextTile(this.fixedTile.position(),directions[a]));break}return isOver?console.log("game over"):console.log("game not over"),isOver},Grid.prototype.currentScore=function(){return this.fixedTile.value},MasterLogic.prototype.findAllDirections=function(position){console.log(this.directions(position))},MasterLogic.prototype.directions=function(tile){var corner=this.isCorner(tile);if(corner)return corner;var center=this.isCenter(tile);return center?center:this.isEdge(tile)},MasterLogic.prototype.isCorner=function(tile){return 0==tile.x&&0==tile.y?[directions.right,directions.down]:tile.x==size-1&&0==tile.y?[directions.left,directions.down]:0==tile.x&&tile.y==size-1?[directions.right,directions.up]:tile.x==size-1&&tile.y==size-1&&[directions.left,directions.up]},MasterLogic.prototype.isCenter=function(tile){return tile.x>0&&tile.x<size-1&&tile.y>0&&tile.y<size-1&&[directions.up,directions.right,directions.down,directions.left]},MasterLogic.prototype.isEdge=function(tile){return 0==tile.x&&tile.y>0&&tile.y<size-1?[directions.up,directions.right,directions.down]:tile.x==size-1&&tile.y>0&&tile.y<size-1?[directions.up,directions.down,directions.left]:0==tile.y&&tile.x>0&&tile.x<size-1?[directions.right,directions.down,directions.left]:tile.y==size-1&&tile.x>0&&tile.x<size-1?[directions.up,directions.right,directions.left]:void 0},Stylesheet.prototype.setup=function(){this.size=size,this.width=width-2,this.minSpace=minSpace;var s=document.querySelector("#flexStyleSheet");null!=s&&s.parentNode.removeChild(s),this.generateTileWidth(),this.generateSpaceBetweenTiles(),this.createStyleSheet()},Stylesheet.prototype.generateTileWidth=function(){this.tileWidth=parseInt((this.width-this.minSpace)/this.size)-this.minSpace},Stylesheet.prototype.generateSpaceBetweenTiles=function(){this.spaceBetweenTiles=parseInt((this.width-this.size*this.tileWidth)/(this.size+1));var spaceOccupiedByTiles=this.tileWidth*this.size+this.spaceBetweenTiles*(this.size-1);this.mainGridWidth=spaceOccupiedByTiles,this.leftPadding=parseInt((this.width-spaceOccupiedByTiles)/2),this.rightPadding=this.width-this.leftPadding-spaceOccupiedByTiles},Stylesheet.prototype.createStyleSheet=function(){var styleSheet=document.createElement("style");styleSheet.setAttribute("id","flexStyleSheet"),styleSheet.setAttribute("type","text/css");var code=".gridContainerOuter{width:"+width+"px;height:"+width+"px}";code+=".gridContainerInner{width:"+this.width+"px;height:"+this.width+"px}",code+=".backgroundGrid,.mainGrid{left:"+this.leftPadding+"px;top:"+this.leftPadding+"px;width:"+this.mainGridWidth+"px;height:"+this.mainGridWidth+"px}",code+=".tile,.bit{width:"+this.tileWidth+"px;height:"+this.tileWidth+"px;line-height:"+this.tileWidth+"px}",code+=this.makeTileClassPositionStyle(),styleSheet.textContent="\n"+code+"\n",document.querySelector("head").appendChild(styleSheet)},Stylesheet.prototype.makeTileClassPositionStyle=function(){var i,j,code="";for(i=0;i<this.size;i++)for(j=0;j<this.size;j++)code+=this.tilePositionClass(i,j)+","+this.bitPositionClass(i,j)+"{left:"+(this.tileWidth+this.spaceBetweenTiles)*i+"px;top:"+(this.tileWidth+this.spaceBetweenTiles)*j+"px}";return code},Stylesheet.prototype.bitPositionClass=function(i,j){return".bit-"+i+"-"+j},Stylesheet.prototype.tilePositionClass=function(i,j){return".tile-"+i+"-"+j},Tile.prototype.position=function(){return{x:this.x,y:this.y}},Tile.prototype.applyChanges=function(){var self=this;this.isVisible?this.classList[2]="visible":this.classList[2]="invisible",null!=this.nextValue&&(this.htmlNode.textContent=this.nextValue,this.classList[5]="updated",this.value=this.nextValue,this.nextValue=null,setTimeout(function(){self.classList[5]="",self.applyClasses()},self.time)),this.applyClasses()},Tile.prototype.positionClass=function(){return"tile-"+this.x+"-"+this.y},Tile.prototype.makeHTMLNode=function(){var tileElement=document.createElement("div");return this.htmlNode=tileElement,tileElement.textContent=this.value,tileElement.setAttribute("id",this.positionClass()),this.htmlNode.setAttribute("class",this.classList.join(" ")),this.htmlNode},Tile.prototype.applyClasses=function(){this.htmlNode.setAttribute("class",this.classList.join(" "))};
//# sourceMappingURL=game.min.js.map